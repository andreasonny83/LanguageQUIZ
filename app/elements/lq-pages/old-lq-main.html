<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="lq-home-page.html">
<link rel="import" href="lq-tile-full.html">
<link rel="import" href="lq-user-profile.html">

<dom-module id="lq-main">
<template>
	<neon-animated-pages id="pages" class="flex" selected="[[selected]]" entry-animation="[[entryAnimation]]" exit-animation="[[exitAnimation]]">

		<lq-home-page id="lqHome" avatar="[[avatar]]" collections="[[collections]]" on-tile-click="_onCollection" on-log-out="_logOut" on-user-profile="_userProfile"></lq-home-page>
		<lq-tile-full id="lqTile" on-go-back="_goBack"></lq-tile-full>
		<lq-user-profile id="lqUserProfile" on-go-back="_goBack"></lq-user-profile>

	</neon-animated-pages>

	<iron-localstorage name="lq-global-collections"
		id="lqCollections"
		value="{{collections}}">
	</iron-localstorage>

	<iron-ajax
		id="ajax_collections"
		method="GET"
		headers={{apiKey}}
		handle-as="json"
		on-response="fetchCollections"
		on-error="fetchCollectionsError">
	</iron-ajax>

	<iron-ajax
		id="ajax_user"
		method="GET"
		headers={{apiKey}}
		handle-as="json"
		on-error="logOut"
		on-response="getUser">
	</iron-ajax>

</template>

<script>

Polymer({
	is: 'lq-main',

	properties: {
		selected: 0,

		collections: {
			type: Object,
			value: []
		},

		items_per_page: {
			type: Number,
			value: 6
		},

		user: {
			type: Object
		},

		avatar: {
			type: String,
			value: appDir + "img/avatar.jpg"
		}
	},

	attached: function() {
		lqMain.$.spinner.active = true; //loading
		window.lqMain          = this;
		this.selected = 0;

		if ( ! lqMain.checkUserCookie() ) {
			return lqMain.$.router.go( '/login/', { replace: true} );
		}

		this.apiKey = lqApiKey;
		this.cleanCollection();
		this.update();
	},

	update: function( n_try ) {
		// Try fetch the user for 3 times,
		// If fails, quit
		var n_try, user_cookie, user_uid;

		// If it fails either to read the user uid from the URL
		// or the cookie information, try reading again
		n_try = n_try ? n_try : 0;

		if ( n_try >= 3 ) {
			// If it has been not possible to verify the user, log out.
			lqMain.fireToast( "It has been impossible to verify the user information. Logging out." );

			return lqMain.logOut();
		}

		this.cleanCollection();

		user_cookie = lqMain.checkUserCookie();
		user_id     = this.uid ? this.uid : null;

		if ( user_cookie && user_id && user_cookie === user_id ) {
			// If the user has been found from both the url and the cookie,
			// verify the user identity using the service API
			this.$.ajax_user.url = apiDir + "user/" + this.uid;
			this.$.ajax_user.generateRequest();

			return;
		}

		this.async( function() {
			this.update( n_try + 1 );
		}, 500 );
	},

	getUser: function( e ) {
		lqMain.$.spinner.active = false; //loading

		// If the user has been verified,
		// complete rendering the home page
		if ( e.detail.response.user ) {
			this.user = e.detail.response.user;
			lqMain.fireToast( "Welcome back " + this.user.username );
			// Read the global collections once the user is logged id and verified
			this.readCollections();
		} else {
			lqMain.logOut( 'Cannot verify the user credentials. Logging out.' );
		}
	},

	/**
	 * cleanCollection
	 *
	 * Clean all the collection objects and empty the local storage
	 */
	cleanCollection: function() {
		this.collections = [];
		this.$.lqCollections.save();
	},

	/**
	 * readCollections
	 *
	 * Request all the collections using an Ajax request to the API
	 */
	readCollections: function( try_again ) {
		try_again = typeof try_again == 'undefined' ? false : try_again;
		var user_cookie = lqMain.checkUserCookie();
		console.log('reading collections');

		if ( user_cookie ) {
			this.$.ajax_collections.url = apiDir + "user/" + user_cookie + "/collections";
			this.$.ajax_collections.generateRequest();
		}
		else if ( ! try_again ) {
			this.async( function() {
				this.readCollections( true );
			}, 500 );
		} else {
			lqMain.logOut( 'Cannot verify the user credentials. Logging out.' );
		}
	},

	/**
	 * fetchCollections
	 *
	 * store all the collections, returned from the Ajax request,
	 * to the browser's local storage
	 */
	fetchCollections: function( e ) {
		var that = this;

		if ( e.detail.response && e.detail.response.collections ) {
			e.detail.response.collections.forEach( function( collection ) {
				that.push( 'collections', collection );
			});
		}

		this.$.lqHome.$.tileLoading.removeAttribute( 'active' );
		console.log('Collections fetched, moving on');
		this.$.lqHome.update();
	},

	fetchCollectionsError: function( e ) {
		this.$.lqHome.$.tileLoading.setAttribute( 'active', true );
		lqMain.fireToast( 'Cannot fetch the collections from the server. Trying again in a while.' );

		this.async( function() {
			this.readCollections();
		}, 10000 );
	},

	/**
	 * logOut
	 *
	 * Perform a secure log out
	 */
	logOut: function( e ) {
		var status = e.detail.request.xhr.response ? e.detail.request.xhr.response : null;

		if ( status && status.msg ) {
			lqMain.fireToast( status.msg );
		}

		return lqMain.logOut();
	},

	_goBack: function() {
		this.entryAnimation = 'slide-from-left-animation';
		this.exitAnimation = 'slide-right-animation';

		this.selected = 0;
	},

	_onCollection: function() {
		this.entryAnimation = 'slide-from-right-animation';
		this.exitAnimation = 'slide-left-animation';

		this.selected = 1;
	},

	_userProfile: function() {
		this.entryAnimation = 'slide-from-right-animation';
		this.exitAnimation = 'slide-left-animation';

		this.selected = 2;
	},

	_logOut: function() {
		lqMain.logOut();
	},

});
</script>
</dom-module>
